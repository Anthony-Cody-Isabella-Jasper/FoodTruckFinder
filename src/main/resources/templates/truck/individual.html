<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" content="width=device-width, initial-scale=1" name="viewport"/>
    <title>StreatFoods</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css"
          integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.js"></script>
    <link rel="stylesheet" th:href="@{/main.css}">
</head>
<body>
<div sec:authorize="isAuthenticated()" th:if="${!#authentication.principal.isAdmin}">
    <nav th:if="${!#authentication.principal.isTruckOwner}">
        <nav th:replace="partials :: loggedNav"></nav>
    </nav>
    <nav th:if="${#authentication.principal.isTruckOwner}">
        <nav th:replace="partials :: truckNav"></nav>
    </nav>
</div>
<div sec:authorize="!isAuthenticated()">
    <nav th:replace="partials :: notLoggedNav"></nav>
</div>
<div sec:authorize="isAuthenticated()" th:if="${#authentication.principal.isAdmin}">
    <nav th:replace="partials :: #adminNav"></nav>
</div>
<div id="mapDiv">
    <div id="map"></div>
    <p>User location verifications: <span th:text="${truck.getConfirmed_users().size()}"></span></p>
    <a th:if="${#authentication.principal.equals('anonymousUser') || !#authentication.principal.isTruckOwner}"
       th:href="'https://www.google.com/maps/search/?api=1&query=' + ${truck.getLatitude()} + ',' + ${truck.getLongitude}"
       target="_blank">
        <button class="btn btn-primary">Get Directions</button>
    </a>

    <div sec:authorize="isAuthenticated()">
        <div th:if="${#authentication.principal.isTruckOwner and #authentication.principal.truck.getId() == truck.id}">
            <div th:if="${truck.longitude == null}" id="triangulateBtn">
                <button class="btn btn-primary" id="triangulate">Mark Your Location!</button>
                <form id="activateBeacon" th:action="@{/truck/{id}/located(id=${truck.id})}" method="post">
                    <input type="hidden" name="longitude" id="truckLongitude">
                    <input type="hidden" name="latitude" id="truckLatitude">
                </form>
            </div>
            <form th:if="${truck.longitude != null}" id="ghost" th:action="@{/truck/{id}/unlocated(id=${truck.id})}"
                  method="post">
                <button class="btn btn-danger" type="submit">Go Ghost</button>
            </form>
        </div>
    </div>
    <div sec:authorize="isAuthenticated()">
        <div th:if="${!#authentication.principal.isTruckOwner && !truck.getConfirmed_users().contains(loggedUser)}">
            <form th:action="@{/truck/verify}" method="post">
                <input type="hidden" name="truckId" th:value="${truck.id}">
                <input type="hidden" name="userId" th:value="${#authentication.principal.getId()}">
                <div id="verifyTruckBtn">
                    <button class="btn btn-success" type="submit">Verify Truck on Location</button>
                </div>
            </form>
        </div>
    </div>
</div>

<hr>
<div id="individualTruck">
    <img th:attr="src=${truck.profile_picture}">
    <div id="individualTruckDescrip">
        <h3 th:text="${truck.name}"></h3>
        <br>
        <dl>
            <dt>Truck's Listed Cuisines:</dt>
            <dd><em th:if="${truck.cuisines.size() == 0}" class="m-2">unknown</em></dd>
            <dd><em th:each="cuisine : ${truck.cuisines}" th:text="${cuisine.name}" class="m-2"></em></dd>
        </dl>
        <hr>
        <p>Phone Number: <span th:text="${truck.phone}"></span></p>
        <br>
        <div id="truckDescription">
            <p>Description: <span th:text="${truck.description}"></span></p>
        </div>
        <br>
        <p id="reviewText">Average Rating:
            <span class="m-2"><span
                    th:style="'background-image:linear-gradient(to right, rgb(255,215,0,1) ' + ${truck.averageRatingPercent()} + '%, rgba(0,0,0,1)' + ${truck.averageRatingPercent()} + '%);-webkit-background-clip:text;-webkit-text-fill-color:transparent'">&#9733;&#9733;&#9733;&#9733;&#9733;</span></span>(<em><span
                    th:text="${truck.getReviews().size()}"></span>
                reviews</em>) </p>
        <div sec:authorize="isAuthenticated()" th:if="${!#authentication.principal.isTruckOwner}">
            <form th:action="@{/addFavorite}" th:method="post">
                <input hidden th:value="${truck.getId()}" name="truckId">
                <input hidden th:value="${#authentication.principal.getId()}" name="id">
                <button class="btn btn-success" type="submit">Add to Favorites</button>
            </form>
        </div>
    </div>
</div>
<hr>
<div>
    <div id="carouselTruckPhotos" class="carousel slide" data-ride="carousel">
        <div class="carousel-inner">
            <div th:if="${stat.first}" th:each="truckPicture, stat : ${truck.truckPictures}"
                 class="carousel-item active">
                <img th:src="${truckPicture.picture}" alt="...">
            </div>
            <div th:unless="${stat.first}" th:each="truckPicture, stat : ${truck.truckPictures}"
                 class="carousel-item">
                <img th:src="${truckPicture.picture}" alt="...">
            </div>
        </div>
        <button class="carousel-control-prev" type="button" data-target="#carouselTruckPhotos" data-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="sr-only">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-target="#carouselTruckPhotos" data-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="sr-only">Next</span>
        </button>
    </div>
</div>

<div id="bottomBox">
    <div id="menuBox">
        <h1>MENU</h1>
        <table class="table">
            <thead>
            <tr>
                <th scope="col">Name</th>
                <th scope="col">Description</th>
                <th scope="col">Price</th>
                <th scope="col">Vegetarian</th>
                <th scope="col">Vegan</th>
            </tr>
            </thead>
            <tbody th:each="menu : ${truck.menu}" class="menu-items">
            <tr>
                <td th:text="${menu.name}"></td>
                <td th:text="${menu.description}"></td>
                <td th:text="${menu.price}"></td>
                <td><span th:if="${menu.vegetarian || menu.vegan}"><i class="bi bi-check"></i></span></td>
                <td><span th:if="${menu.vegan}"><i class="bi bi-check"></i></span></td>
            </tr>
            </tbody>
        </table>
    </div>
    <hr>
    <div id="reviewItems">
        <h3>Reviews</h3>
        <div id="reviewBtn" sec:authorize="isAuthenticated()" th:if="${!#authentication.principal.isTruckOwner}">
            <a th:href="@{/review/{id}(id=${truck.id})}" class="btn btn-primary">Write a Review!</a>
        </div>

        <div th:each="review : ${truck.reviews}" class="truck-reviews" id="reviewContent">
            <div id="reviewLeft">
                <img th:attr="src=${review.user.profilePicture}"> <span th:text="${review.user.username}"></span>
            </div>
            <div>
                <p>"<span th:text="${review.reviewText}"></span>"</p>
                <p>Rating:
                    <span th:style="'background-image:linear-gradient(to right, rgb(255,215,0,1) ' + ${review.rating * 100 / 5} + '%, rgba(0,0,0,1)' + ${review.rating * 100 / 5} + '%);-webkit-background-clip:text;-webkit-text-fill-color:transparent'">&#9733;&#9733;&#9733;&#9733;&#9733;</span>
                </p>
            </div>
        </div>

    </div>
</div>
</div>
<footer th:replace="partials :: footer"></footer>
<div th:replace="partials :: scripts"></div>
<script th:inline="javascript">
    let truckLongitude;
    let truckLatitude;
    let truckName;
    /*<![CDATA[*/
    if (/*[[${message}]]*/) {
        window.alert(/*[[${message}]]*/);
    }
    truckLongitude = /*[[${truck.getLongitude()}]]*/;
    truckLatitude = /*[[${truck.getLatitude()}]]*/;
    truckName = /*[[${truck.getName()}]]*/;
    /*]]>*/
    mapboxgl.accessToken = 'pk.eyJ1IjoiaG9kZ2VzY29keTAwIiwiYSI6ImNreXVtOG5odDFvc2EycHBlaHhpMzF1c3QifQ.6g0ZKujuRweI-lJkBKuWAQ';
    let map;
    if (truckLongitude != null) {
        map = new mapboxgl.Map({
            container: 'map', // container ID
            style: 'mapbox://styles/mapbox/streets-v11', // style URL
            center: [truckLongitude, truckLatitude], // starting position [lng, lat]
            zoom: 9 // starting zoom
        });
        const marker = new mapboxgl.Marker()
            .setLngLat([truckLongitude, truckLatitude])
            .setPopup(new mapboxgl.Popup().setHTML("<h4>" + truckName + "</h4><a href='https://www.google.com/maps/search/?api=1&query=" + truckLatitude + "," + truckLongitude + "' target='_blank'><button class='btn btn-primary'>Get Directions</button></a>"))
            .addTo(map);
    } else {
        map = new mapboxgl.Map({
            container: 'map', // container ID
            style: 'mapbox://styles/mapbox/streets-v11', // style URL
            center: [-98.4946, 29.4252], // starting position [lng, lat]
            zoom: 9 // starting zoom
        });
    }
    map.addControl(new mapboxgl.GeolocateControl({
        positionOptions: {
            enableHighAccuracy: true
        },
        trackUserLocation: true,
        showUserHeading: true
    }));
    map.addControl(new mapboxgl.NavigationControl());
    document.getElementById("triangulate").addEventListener("click", () => {
        let triangulate = document.getElementById("triangulate");
        triangulate.disabled = true;
        triangulate.innerText = "Loading...";
        navigator.geolocation.getCurrentPosition(position => {
            document.getElementById("truckLongitude").value = position.coords.longitude;
            document.getElementById("truckLatitude").value = position.coords.latitude;
            document.getElementById("activateBeacon").submit();
        });
    });
</script>
</body>
</html>